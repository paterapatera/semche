# mcp_server.py 詳細設計書

## 概要

このファイルは、Semcheプロジェクトの MCP (Model Context Protocol) サーバーのメイン実装ファイルです。
FastMCP を使用してシンプルな挨拶ツールを提供し、MCPプロトコルの動作確認用スケルトンとして機能します。

## ファイルパス

`/home/pater/semche/src/semche/mcp_server.py`

## 依存関係

### 外部ライブラリ

- `mcp.server.fastmcp.FastMCP`: MCPサーバーの高レベルAPI

### 利用しているクラス・モジュール

| モジュール/クラス | インポート元         | 用途                    |
| ----------------- | -------------------- | ----------------------- |
| `FastMCP`         | `mcp.server.fastmcp` | MCPサーバーの作成と管理 |

## クラス・関数定義

### グローバル変数

#### `mcp`

```python
mcp = FastMCP("semche")
```

**型**: `FastMCP`

**説明**: MCPサーバーのインスタンス。サーバー名は "semche" として初期化されます。

**用途**:

- ツールの登録
- クライアントとの通信管理
- MCP Inspectorによるデバッグ

---

### 関数

#### `hello(name: str = "World") -> str`

**デコレータ**: `@mcp.tool()`

**説明**: 挨拶メッセージを返すシンプルなツール関数。MCPツールとして公開されます。

**パラメータ**:
| パラメータ名 | 型 | デフォルト値 | 説明 |
|------------|----|-----------|----|
| `name` | `str` | `"World"` | 挨拶する対象の名前（省略可） |

**戻り値**:
| 型 | 説明 |
|----|------|
| `str` | "Hello, {name}!" 形式の挨拶メッセージ |

**使用例**:

```python
# 名前を指定する場合
result = hello(name="Alice")  # "Hello, Alice!"

# 名前を省略する場合（デフォルト値を使用）
result = hello()  # "Hello, World!"
```

**動作フロー**:

1. 引数 `name` を受け取る（省略時は "World" を使用）
2. f-stringを使用して挨拶メッセージを生成
3. 生成したメッセージを返却

**備考**:

- この関数は `@mcp.tool()` デコレータによって自動的にMCPツールとして登録されます
- FastMCPは関数のdocstringをツールの説明として使用します
- 型ヒントはMCPのスキーマ定義に自動変換されます

## データフロー

```
MCPクライアント
    ↓ (ツール呼び出し: "hello")
FastMCPサーバー (mcp)
    ↓ (引数を渡す)
hello関数
    ↓ (挨拶メッセージ生成)
FastMCPサーバー (mcp)
    ↓ (レスポンス返却)
MCPクライアント
```

## エラーハンドリング

現在の実装では明示的なエラーハンドリングは実装されていません。
FastMCPが以下のエラーケースを自動的に処理します：

- 無効なパラメータ型
- 存在しないツールの呼び出し
- 通信エラー

## セキュリティ考慮事項

- 入力値のサニタイゼーション: 現在は未実装（将来的に必要に応じて追加）
- 認証: MCP Inspectorのトークンベース認証を使用
- stdio通信: ローカル実行のため、ネットワーク経由の攻撃リスクは低い

## パフォーマンス考慮事項

- `hello` 関数は同期関数として実装（非常に軽量な処理のため）
- FastMCPが内部で非同期処理を管理

## 将来の拡張予定

このスケルトン実装をベースに、以下の機能を追加予定：

1. **ベクトル埋め込み生成ツール**
   - LangChainとHugging Faceモデルを使用
   - テキストをベクトルに変換

2. **ChromaDB操作ツール**
   - ベクトルデータの保存
   - コレクション管理

3. **類似検索ツール**
   - ベクトルベースの類似度検索
   - 結果のランキング

## テスト

関連テストファイル: `/home/pater/semche/tests/test_mcp_server.py`

テストケース:

- MCPサーバーインスタンスの存在確認
- `hello` 関数の基本動作確認（引数あり・なし）
- 各種カスタム名でのテスト（日本語、空文字列など）

## 使用方法

### 開発モード（MCP Inspector）

```bash
cd /home/pater/semche
uv run mcp dev src/semche/mcp_server.py
```

ブラウザでMCP Inspectorが開き、以下が可能：

- ツール一覧の確認
- インタラクティブなツール呼び出し
- レスポンスの検証

### 本番モード（stdio）

```bash
cd /home/pater/semche
uv run python src/semche/mcp_server.py
```

stdioでMCPプロトコル通信を受け付けます。

## バージョン情報

- 初版作成日: 2025-11-03
- バージョン: 0.1.0
- 最終更新日: 2025-11-03

## 変更履歴

| 日付       | バージョン | 変更内容                                  |
| ---------- | ---------- | ----------------------------------------- |
| 2025-11-03 | 0.1.0      | 初版作成。FastMCPを使用したスケルトン実装 |
